<!DOCTYPE html>
<html>
        <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <title>Traefik V2åŸºäºKubernetesçš„å®‰è£…ä¸ä½¿ç”¨ | HefeiJoe Blog</title>
        <link rel="stylesheet" href="https://hefeijoe.github.io//styles/main.css">
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://cdn.bootcss.com/animate.css/3.7.2/animate.min.css" rel="stylesheet">
         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
        <script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
         <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
         <script >hljs.initHighlightingOnLoad();</script>

    </head>
    <body>
              <header class="header mdui-m-b-5">      
            <div class="container  ">
                <div class="index-title animated fadeInDown mdui-text-center mdui-text-color-white mdui-m-b-2" style="animation-delay: 0.2s"><a href="https://hefeijoe.github.io/">HefeiJoe Blog</a></div>
                <div class="mdui-text-color-white animated fadeInDown mdui-text-center  mdui-m-b-3" style="animation-delay: 0.4s">æ°´æ»´çŸ³ç©¿</div>
           
            <nav id="nav" class="mdui-text-center animated fadeInDown" style="animation-delay: 0.6s">
                   
                            <li><a href="/">é¦–é¡µ</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                            <li><a href="/archives">å½’æ¡£</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                            <li><a href="/tags">æ ‡ç­¾</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                  </nav>
                </div>
        </header>
        <div class="mdui-container ">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                                <article class="mdui-p-a-2 post animated fadeIn" style="animation-delay: 0.8s;animation-duration: 2s">
                                    <div class="post-title  mdui-m-b-1">Traefik V2åŸºäºKubernetesçš„å®‰è£…ä¸ä½¿ç”¨</div>
                                    <div class="mdui-typo-body-2 mdui-m-b-2" datetime="2020-05-20 15:05:06">2020-05-20 / 10 min read</div>
                                    <div class="mdui-m-b-2 mdui-typo post-neirong"><h1 id="æ ¸å¿ƒæ¦‚å¿µ">æ ¸å¿ƒæ¦‚å¿µğŸ˜€</h1>
<p>Traefik æ˜¯ä¸€ä¸ªè¾¹ç¼˜è·¯ç”±å™¨ï¼Œæ˜¯ä½ æ•´ä¸ªå¹³å°çš„å¤§é—¨ï¼Œæ‹¦æˆªå¹¶è·¯ç”±æ¯ä¸ªä¼ å…¥çš„è¯·æ±‚ï¼šå®ƒçŸ¥é“æ‰€æœ‰çš„é€»è¾‘å’Œè§„åˆ™ï¼Œè¿™äº›è§„åˆ™ç¡®å®šå“ªäº›æœåŠ¡å¤„ç†å“ªäº›è¯·æ±‚ï¼›ä¼ ç»Ÿçš„åå‘ä»£ç†éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«è·¯ç”±åˆ°ä½ æœåŠ¡çš„æ‰€æœ‰å¯èƒ½è·¯ç”±ï¼Œè€Œ Traefik ä¼šå®æ—¶æ£€æµ‹æœåŠ¡å¹¶è‡ªåŠ¨æ›´æ–°è·¯ç”±è§„åˆ™ï¼Œå¯ä»¥è‡ªåŠ¨æœåŠ¡å‘ç°ã€‚<br>
<img src="https://docs.traefik.io/assets/img/traefik-architecture.png" alt="img" loading="lazy"><br>
é¦–å…ˆï¼Œå½“å¯åŠ¨ Traefik æ—¶ï¼Œéœ€è¦å®šä¹‰ entrypointsï¼ˆå…¥å£ç‚¹ï¼‰ï¼Œç„¶åï¼Œæ ¹æ®è¿æ¥åˆ°è¿™äº› entrypoints çš„è·¯ç”±æ¥åˆ†æä¼ å…¥çš„è¯·æ±‚ï¼Œæ¥æŸ¥çœ‹ä»–ä»¬æ˜¯å¦ä¸ä¸€ç»„è§„åˆ™ç›¸åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™è·¯ç”±å¯èƒ½ä¼šå°†è¯·æ±‚é€šè¿‡ä¸€ç³»åˆ—ä¸­é—´ä»¶è½¬æ¢è¿‡åå†è½¬å‘åˆ°ä½ çš„æœåŠ¡ä¸Šå»ã€‚åœ¨äº†è§£ Traefik ä¹‹å‰æœ‰å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µæˆ‘ä»¬å¿…é¡»è¦äº†è§£ï¼š</p>
<ul>
<li><strong>Providers</strong> ç”¨æ¥è‡ªåŠ¨å‘ç°å¹³å°ä¸Šçš„æœåŠ¡ï¼Œå¯ä»¥æ˜¯ç¼–æ’å·¥å…·ã€å®¹å™¨å¼•æ“æˆ–è€… key-value å­˜å‚¨ç­‰ï¼Œæ¯”å¦‚ Dockerã€Kubernetesã€Fileã€‚</li>
<li><strong>Entrypoints</strong> ç›‘å¬ä¼ å…¥çš„æµé‡ï¼ˆç«¯å£ç­‰â€¦ï¼‰ï¼Œæ˜¯ç½‘ç»œå…¥å£ç‚¹ï¼Œå®ƒä»¬å®šä¹‰äº†æ¥æ”¶è¯·æ±‚çš„ç«¯å£ï¼ˆHTTP æˆ–è€… TCPï¼‰ã€‚</li>
<li><strong>Routers</strong> åˆ†æè¯·æ±‚ï¼ˆhost, path, headers, SSL, â€¦ï¼‰ï¼Œè´Ÿè´£å°†ä¼ å…¥è¯·æ±‚è¿æ¥åˆ°å¯ä»¥å¤„ç†è¿™äº›è¯·æ±‚çš„æœåŠ¡ä¸Šå»ã€‚</li>
<li><strong>Services</strong> å°†è¯·æ±‚è½¬å‘ç»™ä½ çš„åº”ç”¨ï¼ˆload balancing, â€¦ï¼‰ï¼Œè´Ÿè´£é…ç½®å¦‚ä½•è·å–æœ€ç»ˆå°†å¤„ç†ä¼ å…¥è¯·æ±‚çš„å®é™…æœåŠ¡ã€‚</li>
<li><strong>Middlewares</strong> ä¸­é—´ä»¶ï¼Œç”¨æ¥ä¿®æ”¹è¯·æ±‚æˆ–è€…æ ¹æ®è¯·æ±‚æ¥åšå‡ºä¸€äº›åˆ¤æ–­ï¼ˆauthentication, rate limiting, headers, â€¦ï¼‰ï¼Œä¸­é—´ä»¶è¢«é™„ä»¶åˆ°è·¯ç”±ä¸Šï¼Œæ˜¯ä¸€ç§åœ¨è¯·æ±‚å‘é€åˆ°ä½ çš„æœåŠ¡ä¹‹å‰ï¼ˆæˆ–è€…åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼‰è°ƒæ•´è¯·æ±‚çš„ä¸€ç§æ–¹æ³•ã€‚</li>
</ul>
<h1 id="éƒ¨ç½²">éƒ¨ç½²ğŸ˜„</h1>
<h2 id="kubernetes">Kubernetes</h2>
<p>ç”±äº Traefik 2.X ç‰ˆæœ¬å’Œä¹‹å‰çš„ 1.X ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰æ‹©åŠŸèƒ½æ›´åŠ å¼ºå¤§çš„ 2.X ç‰ˆæœ¬è¿›è¡Œéƒ¨ç½²ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„é•œåƒæ˜¯ traefik:2.0.2ã€‚<br>
åœ¨ Traefik ä¸­çš„é…ç½®å¯ä»¥ä½¿ç”¨ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼š</p>
<ul>
<li><strong>åŠ¨æ€é…ç½®</strong>ï¼šå®Œå…¨åŠ¨æ€çš„è·¯ç”±é…ç½®</li>
<li><strong>é™æ€é…ç½®</strong>ï¼šå¯åŠ¨é…ç½®<br>
é™æ€é…ç½®ä¸­çš„å…ƒç´ ï¼ˆè¿™äº›å…ƒç´ ä¸ä¼šç»å¸¸æ›´æ”¹ï¼‰è¿æ¥åˆ° providers å¹¶å®šä¹‰ Treafik å°†è¦ç›‘å¬çš„ entrypointsã€‚<br>
åœ¨ Traefik ä¸­æœ‰ä¸‰ç§æ–¹å¼å®šä¹‰é™æ€é…ç½®ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ã€åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­ã€é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’<br>
åŠ¨æ€é…ç½®åŒ…å«å®šä¹‰ç³»ç»Ÿå¦‚ä½•å¤„ç†è¯·æ±‚çš„æ‰€æœ‰é…ç½®å†…å®¹ï¼Œè¿™äº›é…ç½®æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œè€Œä¸”æ˜¯æ— ç¼çƒ­æ›´æ–°çš„ï¼Œæ²¡æœ‰ä»»ä½•è¯·æ±‚ä¸­æ–­æˆ–è¿æ¥æŸè€—ã€‚<br>
åœ¨Kubernetesé›†ç¾¤ä¸‹ï¼Œé‡‡ç”¨Deploymentçš„æ–¹å¼éƒ¨ç½²traefikï¼Œå¹¶ä¸”æ‰“å¼€kubernetes ingressï¼Œä»¥åŠprometheus metricsã€‚<br>
<em>æ³¨ï¼šé»˜è®¤å®‰è£…åœ¨<strong>default</strong>ä¸‹</em></li>
</ul>
<h3 id="crdä¸rbac">CRDä¸RBAC</h3>
<p>é¦–å…ˆï¼Œå®šä¹‰CRDåŒ…æ‹¬IngressRouteå’ŒMiddlewareã€‚å¹¶ä¸”é€šè¿‡RBACæˆæƒèµ„æºã€‚<br>
å‚è§ï¼šhttps://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-crd.yaml<br>
<em>æ³¨ï¼šé»˜è®¤å®‰è£…åœ¨<strong>default</strong>ä¸‹</em></p>
<pre><code>kubectl apply -f https://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-crd.yaml
</code></pre>
<h3 id="service">Service</h3>
<p>å‚è§ï¼šhttps://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-service.yaml</p>
<pre><code>kubectl apply -f https://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-crd.yaml
</code></pre>
<p>éƒ¨ç½²å®Œæˆtraefikçš„EXTERNAL-IPä¸º<a href="http://172.21.92.148:8080/dashboard/#/">172.21.92.146</a></p>
<h3 id="deployments">Deployments</h3>
<p>å‚è§ï¼šhttps://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-deployment.yaml</p>
<pre><code>kubectl apply -f https://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-deployment.yaml
</code></pre>
<pre><code>apiVersion: v1
kind: ServiceAccount
metadata:
 name: traefik-ingress-controller
---
kind: Deployment
apiVersion: apps/v1
metadata:
 name: traefik
 labels:
  app: traefik
spec:
 replicas: 1
 selector:
  matchLabels:
   app: traefik
 template:
  metadata:
   labels:
â€‹    app: traefik
  spec:
   serviceAccountName: traefik-ingress-controller
   containers:
â€‹    - name: traefik
â€‹     image: traefik:v2.0.2
â€‹     args:
â€‹      - --api.insecure
â€‹      - --accesslog
â€‹      - --entrypoints.web.Address=:8000
â€‹      - --entrypoints.websecure.Address=:4443
â€‹      - --providers.kubernetescrd
â€‹      - --certificatesresolvers.default.acme.tlschallenge
â€‹      - --certificatesresolvers.default.acme.email=foo@you.com
â€‹      - --certificatesresolvers.default.acme.storage=acme.json
â€‹      - --providers.kubernetesingress=true
â€‹      - --providers.kubernetesingress.ingressclass=traefik
â€‹      - --metrics.prometheus=true
â€‹      - --entryPoints.metrics.address=:8082
â€‹      - --metrics.prometheus.entryPoint=metrics
â€‹      - --certificatesresolvers.default.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
â€‹     ports:
â€‹      - name: web
â€‹       containerPort: 8000
â€‹      - name: websecure
â€‹       containerPort: 4443
â€‹      - name: admin
â€‹       containerPort: 8080
â€‹      - name: prometheus
â€‹       containerPort: 8082
</code></pre>
<h3 id="è®¿é—®dashboard">è®¿é—®DashBoard</h3>
<p>è®¿é—®8080ç«¯å£ï¼Œ<a href="http://172.21.92.148:8080/dashboard/#/">http://172.21.92.146:8080/dashboard/#/</a><br>
å¯ä»¥æŸ¥çœ‹å¼€å¯çš„ç«¯å£ã€æ·»åŠ çš„HTTPæœåŠ¡ã€æ·»åŠ çš„TCPæœåŠ¡ã€å¯ç”¨çš„Middlewareã€å¯ç”¨çš„Featuresã€å·²ç»æˆä¿¡çš„åŠŸèƒ½ã€‚<br>
<img src="https://uploader.shimo.im/f/9KL50flf9hg1UaL8.png!thumbnail" alt="img" loading="lazy"></p>
<h2 id="helm-chart">Helm Chart</h2>
<p>Helm Chartåœ°å€ï¼šhttps://github.com/containous/traefik-helm-chart<br>
helm install --namespace=default  ./traefik-helm-chart<br>
#ä½¿ç”¨</p>
<h3 id="éƒ¨ç½²whoamiæœåŠ¡">éƒ¨ç½²whoamiæœåŠ¡</h3>
<p>éƒ¨ç½²æµ‹è¯•æœåŠ¡whoami<br>
å‚è§ï¼šhttps://github.com/HefeiJoe/traefik-k8s/blob/master/whoami.yaml</p>
<h2 id="ingress">Ingress</h2>
<p>åœ¨traefikçš„Deploymentä¸­çš„argä¸‹æ·»åŠ CLI<br>
<em>- --providers.kubernetesingress=true</em><br>
<em>- --providers.kubernetesingress.ingressclass=traefik</em><br>
1ã€åˆ›å»ºIngress</p>
<pre><code>kind: Ingress
apiVersion: extensions/v1beta1
metadata:
  namespace: default
 name: traefik-ingress
 annotations:
  *# use the shared ingress-nginx*
  kubernetes.io/ingress.class: traefik
</code></pre>
<p>2ã€éªŒè¯<br>
è®¿é—®æœåŠ¡curl -i 172.21.92.146:8000  -H &quot;Host:whoami.kong.test&quot;ï¼Œæ¥å£å“åº”200<br>
<img src="https://uploader.shimo.im/f/ffocrRF3UjkXYBEb.png!thumbnail" alt="img" loading="lazy"></p>
<h2 id="ingressroute">IngressRoute</h2>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: simpleingressroute
  namespace: default
spec:
  entryPoints:
â€‹    - web
  routes:
  - match: Host(`172.21.92.148`) &amp;&amp; PathPrefix(`/whoami`)
â€‹    kind: Rule
â€‹    services:
â€‹    - name: whoami
â€‹      port: 80
</code></pre>
<p>é€šè¿‡http://172.21.92.148:8000/whoamiè®¿é—®</p>
<h2 id="middlewaresä¸­é—´ä»¶">Middlewaresï¼ˆä¸­é—´ä»¶ï¼‰</h2>
<h3 id="overviewæ¦‚è¿°">Overviewï¼ˆæ¦‚è¿°ï¼‰</h3>
<h3 id=""><img src="https://uploader.shimo.im/f/S1b2FXezLpQkSqx3.png!thumbnail" alt="img" loading="lazy"></h3>
<p>å°†ä¸­é—´ä»¶æ·»åŠ åˆ°Routeï¼Œåœ¨è¯·æ±‚å‘é€åˆ°æœåŠ¡ä¹‹å‰(æˆ–åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰)è°ƒæ•´è¯·æ±‚ã€‚<br>
Traefikä¸­æœ‰è®¸å¤šä¸åŒçš„ä¸­é—´ä»¶ï¼Œæœ‰äº›å¯ä»¥ä¿®æ”¹è¯·æ±‚ã€å¤´æ–‡ä»¶ï¼Œæœ‰äº›è´Ÿè´£é‡å®šå‘ï¼Œæœ‰äº›æ·»åŠ èº«ä»½éªŒè¯ï¼Œç­‰ç­‰ã€‚<br>
<strong>ç»™Routeç»‘å®šMiddleware</strong><br>
åœ¨ingressRouteä¸­æ·»åŠ middlewares<br>
<em># As a Kubernetes Traefik IngressRoute</em></p>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: stripprefix
spec:
  stripPrefix:
â€‹    prefixes:
â€‹      - /stripit
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: simpleingressroute
  namespace: default
spec:
  entryPoints:
â€‹    - web
  routes:
  - match: Host(`172.21.92.148`) &amp;&amp; PathPrefix(`/whoami`)
â€‹    kind: Rule
â€‹    services:
â€‹    - name: whoami
â€‹      port: 80
â€‹    middlewares:
- name: stripprefix
</code></pre>
<p>Available Middlewares<a href="https://docs.traefik.io/middlewares/overview/#available-middlewares">Â¶</a></p>
<table>
<thead>
<tr>
<th>Middleware</th>
<th>Purpose</th>
<th>Area</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.traefik.io/middlewares/addprefix/">AddPrefix</a></td>
<td>Add a Path Prefix</td>
<td>Path Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/basicauth/">BasicAuth</a></td>
<td>Basic auth mechanism</td>
<td>Security, Authentication</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/buffering/">Buffering</a></td>
<td>Buffers the request/response</td>
<td>Request Lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/chain/">Chain</a></td>
<td>Combine multiple pieces of middleware</td>
<td>Middleware tool</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/circuitbreaker/">CircuitBreaker</a></td>
<td>Stop calling unhealthy services</td>
<td>Request Lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/compress/">Compress</a></td>
<td>Compress the response</td>
<td>Content Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/digestauth/">DigestAuth</a></td>
<td>Adds Digest Authentication</td>
<td>Security, Authentication</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/errorpages/">Errors</a></td>
<td>Define custom error pages</td>
<td>Request Lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/forwardauth/">ForwardAuth</a></td>
<td>Authentication delegation</td>
<td>Security, Authentication</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/headers/">Headers</a></td>
<td>Add / Update headers</td>
<td>Security</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/ipwhitelist/">IPWhiteList</a></td>
<td>Limit the allowed client IPs</td>
<td>Security, Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/inflightreq/">InFlightReq</a></td>
<td>Limit the number of simultaneous connections</td>
<td>Security, Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/passtlsclientcert/">PassTLSClientCert</a></td>
<td>Adding Client Certificates in a Header</td>
<td>Security</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/ratelimit/">RateLimit</a></td>
<td>Limit the call frequency</td>
<td>Security, Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/redirectscheme/">RedirectScheme</a></td>
<td>Redirect easily the client elsewhere</td>
<td>Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/redirectregex/">RedirectRegex</a></td>
<td>Redirect the client elsewhere</td>
<td>Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/replacepath/">ReplacePath</a></td>
<td>Change the path of the request</td>
<td>Path Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/replacepathregex/">ReplacePathRegex</a></td>
<td>Change the path of the request</td>
<td>Path Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/retry/">Retry</a></td>
<td>Automatically retry the request in case of errors</td>
<td>Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/stripprefix/">StripPrefix</a></td>
<td>Change the path of the request</td>
<td>Path Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/stripprefixregex/">StripPrefixRegex</a></td>
<td>Change the path of the request</td>
<td>Path Modifier</td>
</tr>
</tbody>
</table>
<h3 id="addprefixæ·»åŠ å‰ç¼€">AddPrefixï¼ˆæ·»åŠ å‰ç¼€ï¼‰</h3>
<p><img src="https://uploader.shimo.im/f/1hy4I9o9piED68sO.png!thumbnail" alt="img" loading="lazy"><br>
<em># Prefixing with /foo</em></p>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: add-foo
spec:
  addPrefix:
â€‹    prefix: /foo
</code></pre>
<table>
<thead>
<tr>
<th>é…ç½®é€‰é¡¹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>prefix</td>
<td>prefixæ˜¯æ·»åŠ åœ¨è¯·æ±‚çš„URLè·¯å¾„ä¹‹å‰çš„å­—ç¬¦ä¸²ã€‚å®ƒåº”è¯¥åŒ…æ‹¬å‰å¯¼æ–œæ (/)ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/addprefix/#prefix">Â¶</a></td>
</tr>
</tbody>
</table>
<h3 id="basicauthåŸºæœ¬è®¤è¯">BasicAuthï¼ˆåŸºæœ¬è®¤è¯ï¼‰</h3>
<p><img src="https://uploader.shimo.im/f/IRa08Sg9kIIT5DuU.png!thumbnail" alt="img" loading="lazy"><br>
<em># Declaring the user list</em></p>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: test-auth
spec:
  basicAuth:
â€‹    secret: secretName
</code></pre>
<table>
<thead>
<tr>
<th>é…ç½®é€‰é¡¹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>secret</td>
<td>ç»‘å®šåˆ›å»ºçš„secretã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#configuration-examples">Â¶</a></td>
</tr>
<tr>
<td>users</td>
<td>è¯¥usersé€‰é¡¹æ˜¯ä¸€ç»„æˆæƒç”¨æˆ·ã€‚æ¯ä¸ªç”¨æˆ·éƒ½å°†ä½¿ç”¨ä»¥ä¸‹name:encoded-passwordæ ¼å¼å£°æ˜ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#usersfile">Â¶</a></td>
</tr>
<tr>
<td>usersFile</td>
<td>è¯¥usersFileé€‰é¡¹æ˜¯åŒ…å«ä¸­é—´ä»¶æˆæƒç”¨æˆ·çš„å¤–éƒ¨æ–‡ä»¶çš„è·¯å¾„ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#realm">Â¶</a></td>
</tr>
<tr>
<td>realm</td>
<td>æ‚¨å¯ä»¥ä½¿ç”¨realmé€‰é¡¹æ¥è‡ªå®šä¹‰èº«ä»½éªŒè¯é¢†åŸŸã€‚é»˜è®¤å€¼ä¸ºtraefikã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#realm">Â¶</a></td>
</tr>
<tr>
<td>headerField</td>
<td>æ‚¨å¯ä»¥ä½¿ç”¨è¯¥headerFieldé€‰é¡¹å®šä¹‰æ ‡é¢˜å­—æ®µä»¥å­˜å‚¨ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#headerfield">Â¶</a></td>
</tr>
<tr>
<td>removeHeader</td>
<td>è®¾ç½®removeHeaderé€‰é¡¹ä»¥trueåœ¨å°†è¯·æ±‚è½¬å‘åˆ°æœåŠ¡ä¹‹å‰åˆ é™¤æˆæƒæ ‡å¤´ã€‚ï¼ˆé»˜è®¤å€¼ä¸ºfalseã€‚ï¼‰å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#removeheader">Â¶</a></td>
</tr>
</tbody>
</table>
<h3 id="circuitbreakeræ–­è·¯å™¨">CircuitBreakerï¼ˆæ–­è·¯å™¨ï¼‰</h3>
<p><img src="https://uploader.shimo.im/f/Jf3qvl3fwsgp5pDV.png!thumbnail" alt="img" loading="lazy"><br>
æ–­è·¯å™¨å¯ä¿æŠ¤æ‚¨çš„ç³»ç»Ÿå…äºå°†è¯·æ±‚å †å åˆ°ä¸æ­£å¸¸çš„æœåŠ¡ï¼ˆå¯¼è‡´çº§è”æ•…éšœï¼‰çš„éº»çƒ¦ã€‚<br>
ç³»ç»Ÿè¿è¡ŒçŠ¶å†µè‰¯å¥½æ—¶ï¼Œç”µè·¯å¤„äºé—­åˆçŠ¶æ€ï¼ˆæ­£å¸¸è¿è¡Œï¼‰ã€‚å½“ç³»ç»Ÿè¿è¡Œä¸æ­£å¸¸æ—¶ï¼Œç”µè·¯å°†æ–­å¼€ï¼Œå¹¶ä¸”ä¸å†è½¬å‘è¯·æ±‚ï¼ˆè€Œæ˜¯ç”±åå¤‡æœºåˆ¶å¤„ç†ï¼‰ã€‚<br>
ä¸ºäº†è¯„ä¼°æ‚¨çš„ç³»ç»Ÿæ˜¯å¦å¥åº·ï¼Œæ–­è·¯å™¨ä¸æ–­ç›‘è§†æœåŠ¡ã€‚<br>
<em># Latency Check</em></p>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: latency-check
spec:
  circuitBreaker:
â€‹    expression: LatencyAtQuantileMS(50.0) &gt; 100
</code></pre>
<table>
<thead>
<tr>
<th>é…ç½®é€‰é¡¹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>NetworkErrorRatio</td>
<td>å¦‚æœæ‚¨å¸Œæœ›æ–­è·¯å™¨ä»¥30ï¼…çš„ç½‘ç»œé”™è¯¯ç‡è§¦å‘ï¼Œåˆ™è¡¨è¾¾å¼ä¸º NetworkErrorRatio() &gt; 0.30ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/addprefix/#prefix">Â¶</a></td>
</tr>
<tr>
<td>ResponseCodeRatio</td>
<td>æ‚¨å¯ä»¥æ ¹æ®ç»™å®šèŒƒå›´çš„çŠ¶æ€ç çš„æ¯”ç‡æ¥è§¦å‘æ–­è·¯å™¨ã€‚åœ¨ResponseCodeRatioæ¥å—å››ä¸ªå‚æ•°ï¼Œfromï¼Œtoï¼ŒdividedByFromï¼ŒdividedByToã€‚ä¾‹å¦‚ï¼ŒResponseCodeRatio(500, 600, 0, 600) &gt; 0.25å¦‚æœ25ï¼…çš„è¯·æ±‚è¿”å›5XXçŠ¶æ€ï¼ˆåœ¨è¿”å›çŠ¶æ€ä»£ç ä»0åˆ°5XXçš„è¯·æ±‚ä¸­ï¼‰ï¼Œåˆ™è¡¨è¾¾å¼å°†è§¦å‘æ–­è·¯å™¨ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/circuitbreaker/#responsecoderatio">Â¶</a></td>
</tr>
<tr>
<td>LatencyAtQuantileMS</td>
<td>å½“ç»™å®šæ¯”ä¾‹çš„è¯·æ±‚å˜å¾—å¤ªæ…¢æ—¶ï¼Œæ‚¨å¯ä»¥è§¦å‘æ–­è·¯å™¨ã€‚ä¾‹å¦‚ï¼Œå½“ä¸­LatencyAtQuantileMS(50.0) &gt; 100å€¼ç­‰å¾…æ—¶é—´ï¼ˆåˆ†ä½æ•°50ï¼‰è¾¾åˆ°100MSæ—¶ï¼Œè¯¥è¡¨è¾¾å¼å°†è§¦å‘æ–­è·¯å™¨ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/circuitbreaker/#latencyatquantilems">Â¶</a>æ‚¨å¿…é¡»æä¾›åˆ†ä½æ•°çš„æµ®ç‚¹æ•°ï¼ˆåè·Ÿ.0ï¼‰</td>
</tr>
</tbody>
</table>
<h2 id="metrics">Metrics</h2>
<h3 id="prometheus">Prometheus</h3>
<p>åœ¨traefikçš„Deploymentä¸­çš„argä¸‹æ·»åŠ CLIï¼ˆå¦‚æœé‡‡ç”¨HelmChartéƒ¨ç½²ï¼Œåœ¨values.yamlçš„additionalArgumentsä¸‹æ·»åŠ ä»¥ä¸‹CLIï¼‰ï¼Œå¹¶ä¸”ä¿®æ”¹Serviceæš´éœ²ç«¯å£8082<br>
<em>- --metrics.prometheus=true</em><br>
<em>- --entryPoints.metrics.address=:8082</em><br>
<em>- --metrics.prometheus.entryPoint=metrics</em><br>
é€šè¿‡8082ç«¯å£å¯ä»¥æŸ¥çœ‹prometheusçš„metricsï¼Œ<a href="http://172.21.92.148:8082/metrics">http://172.21.92.146:8082/metrics</a></p>
<h2 id="tracing">Tracing</h2>
<h3 id="zipkin">Zipkin</h3>
<p>1ã€éƒ¨ç½²Zipkin<br>
ç•¥<br>
2ã€åœ¨traefikçš„Deploymentä¸­çš„argä¸‹æ·»åŠ CLIï¼ˆå¦‚æœé‡‡ç”¨HelmChartéƒ¨ç½²ï¼Œåœ¨values.yamlçš„additionalArgumentsä¸‹æ·»åŠ ä»¥ä¸‹CLIï¼‰<br>
<em>- --tracing.zipkin=true</em><br>
<em>- --tracing.zipkin.httpEndpoint=http://localhost:9411/api/v2/spans</em><br>
<em>- --tracing.zipkin.sampleRate=1.0</em><br>
è®¿é—®zipkinçš„åœ°å€ï¼Œhttp://localhost:9411/</p>
</div>
                                    <div class="mdui-divider mdui-m-b-2"></div>
                                    <div class="mdui-row-xs-2 post-fenye">
                                       
                                        <div class="mdui-col"> <div class="mdui-text-left"><a href="https://hefeijoe.github.io/post/stackandheap/">Javaä¸­çš„å †(heap)å’Œæ ˆ(stack)</a></div></div>
                                        

                                        
                                        <div class="mdui-col"></div>
                                       
                                      </div>
                                   
                                    <div class="mdui-divider mdui-m-t-2 mdui-m-b-2"></div>
                                    
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: 'c3b755731b93e141a8f3',
    clientSecret: 'ff1597668ceb63c05bdc5617f1346b10febaadfb',
    repo: 'HefeiJoe.github.io',
    owner: 'HefeiJoe',
    admin: ['HefeiJoe'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          
          
        
                                     <script src="https://hefeijoe.github.io//media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',



            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })
    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                                </article>

                                    
                        </div>
                      </div>
    
                

              </div>
                    <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                      
                           
                      
                           
                      	
                        <li class="social-link"><a href="https://github.com/HefeiJoe" target="_blank"><i class="iconfont icon-github"></i></a></li>
                          
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      </ul>
                    </nav>
                    <div class="copyright">
                      <p>Powered by <a href="https://github.com/HefeiJoe" target="_blank">GitHub</a> <br/> Theme <a href="https://github.com/alterfang/gridea-theme-song/" target="_blank"  title="å®‹"  >Song</a> by <a href="https://shanbu.fun/" target="_blank"  title="å±±åœæ–¹" >shanbufun</a> </p>
                  </div>
                  
              </footer>
    </body>
</html>