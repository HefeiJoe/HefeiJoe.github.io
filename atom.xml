<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://hefeijoe.github.io/</id>
    <title>HefeiJoe Blog</title>
    <updated>2020-06-22T03:29:20.908Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://hefeijoe.github.io/"/>
    <link rel="self" href="https://hefeijoe.github.io/atom.xml"/>
    <subtitle>æ°´æ»´çŸ³ç©¿</subtitle>
    <logo>https://hefeijoe.github.io/images/avatar.png</logo>
    <icon>https://hefeijoe.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, HefeiJoe Blog</rights>
    <entry>
        <title type="html"><![CDATA[å•ä¾‹æ¨¡å¼çš„åº”ç”¨åœºæ™¯]]></title>
        <id>https://hefeijoe.github.io/post/singeleton/</id>
        <link href="https://hefeijoe.github.io/post/singeleton/">
        </link>
        <updated>2020-06-22T02:37:07.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å®šä¹‰">å®šä¹‰ğŸ˜€</h2>
<p>å•ä¾‹æ¨¡å¼æ˜¯æœ€ç®€å•çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œå±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œç¡®ä¿åªæœ‰å•ä¸ªå¯¹è±¡è¢«åˆ›å»ºã€‚<br>
è¿™ä¸ªè®¾è®¡æ¨¡å¼ä¸»è¦ç›®çš„æ˜¯æƒ³åœ¨æ•´ä¸ªç³»ç»Ÿä¸­åªèƒ½å‡ºç°ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œå³ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå¯¹è±¡ã€‚<br>
å•ä¾‹æ¨¡å¼èƒ½å¤Ÿå®ç°æ‡’åŠ è½½ï¼Œèƒ½å¤Ÿåœ¨ä½¿ç”¨å®ä¾‹çš„æ—¶å€™æ‰å»åˆ›å»ºå®ä¾‹ã€‚å¼€å‘å·¥å…·ç±»åº“ä¸­çš„å¾ˆå¤šå·¥å…·ç±»éƒ½åº”ç”¨äº†å•ä¾‹æ¨¡å¼ï¼Œæ¯”ä¾‹çº¿ç¨‹æ± ã€ç¼“å­˜ã€æ—¥å¿—å¯¹è±¡ç­‰ï¼Œå®ƒä»¬éƒ½åªéœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚<br>
å¦‚æœåˆ›å»ºå¤šä»½å®ä¾‹ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼Œæ¯”å¦‚èµ„æºçš„æµªè´¹ã€ç»“æœå¤„ç†ä¸ä¸€è‡´ç­‰é—®é¢˜ã€‚å•ä¾‹æ¨¡å¼çš„è§£å†³çš„ç—›ç‚¹å°±æ˜¯èŠ‚çº¦èµ„æºï¼ŒèŠ‚çœæ—¶é—´ä»ä¸¤ä¸ªæ–¹é¢çœ‹ã€‚</p>
<ol>
<li>ç”±äºé¢‘ç¹ä½¿ç”¨çš„å¯¹è±¡ï¼Œå¯ä»¥çœç•¥åˆ›å»ºå¯¹è±¡æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œè¿™å¯¹äºé‚£äº›é‡é‡çº§çš„å¯¹è±¡è€Œè¨€ï¼Œæ˜¯å¾ˆé‡è¦çš„.</li>
<li>å› ä¸ºä¸éœ€è¦é¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œæˆ‘ä»¬çš„GCå‹åŠ›ä¹Ÿå‡è½»äº†ï¼Œè€Œåœ¨GCä¸­ä¼šæœ‰STW(stop the world)ï¼Œä»è¿™ä¸€æ–¹é¢ä¹ŸèŠ‚çº¦äº†GCçš„æ—¶é—´ å•ä¾‹æ¨¡å¼çš„ç¼ºç‚¹ï¼šç®€å•çš„å•ä¾‹æ¨¡å¼è®¾è®¡å¼€å‘éƒ½æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å¤æ‚çš„å•ä¾‹æ¨¡å¼éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨ç­‰å¹¶å‘é—®é¢˜ï¼Œå¼•å…¥äº†éƒ¨åˆ†å¤æ‚åº¦ã€‚</li>
</ol>
<table>
<thead>
<tr>
<th>é¥¿æ±‰å¼</th>
<th>çº¿ç¨‹å®‰å…¨</th>
<th>å¹¶å‘æ€§èƒ½å¥½</th>
<th>å¯ä»¥å»¶è¿ŸåŠ è½½</th>
<th>åºåˆ—åŒ–/ååºåˆ—åŒ–å®‰å…¨</th>
<th>èƒ½æŠµå¾¡åå°„æ”»å‡»</th>
</tr>
</thead>
<tbody>
<tr>
<td>é¥¿æ±‰å¼</td>
<td>Y</td>
<td>Y</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>æ‡’æ±‰å¼</td>
<td>ä¸åŠ é”</td>
<td></td>
<td>Y</td>
<td>Y</td>
<td></td>
</tr>
<tr>
<td>åŠ é”çš„</td>
<td>Y</td>
<td></td>
<td>Y</td>
<td></td>
<td></td>
</tr>
<tr>
<td>DCL</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td></td>
<td></td>
</tr>
<tr>
<td>é™æ€å†…éƒ¨ç±»</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td></td>
<td></td>
</tr>
<tr>
<td>æšä¸¾</td>
<td>Y</td>
<td>Y</td>
<td></td>
<td>Y</td>
<td>Y</td>
</tr>
</tbody>
</table>
<h2 id="è®¾è®¡">è®¾è®¡ğŸ˜</h2>
<p>è®¾è®¡å•ä¾‹æ¨¡å¼çš„æ—¶å€™ä¸€èˆ¬éœ€è¦è€ƒè™‘å‡ ç§å› ç´ :</p>
<ul>
<li>çº¿ç¨‹å®‰å…¨</li>
<li>å»¶è¿ŸåŠ è½½</li>
<li>ä»£ç å®‰å…¨:å¦‚é˜²æ­¢åºåˆ—åŒ–æ”»å‡»ï¼Œé˜²æ­¢åå°„æ”»å‡»(é˜²æ­¢åå°„è¿›è¡Œç§æœ‰æ–¹æ³•è°ƒç”¨)</li>
<li>æ€§èƒ½å› ç´ <br>
é¥¿æ±‰ï¼Œæ‡’æ±‰(çº¿ç¨‹å®‰å…¨ï¼Œçº¿ç¨‹éå®‰å…¨)ï¼ŒåŒé‡æ£€æŸ¥(DCL)(é‡ç‚¹),å†…éƒ¨ç±»ï¼Œä»¥åŠæšä¸¾(é‡ç‚¹)ã€‚</li>
</ul>
<h2 id="å®ç°">å®ç°ğŸ˜˜</h2>
<h3 id="é¥¿æ±‰æ¨¡å¼">é¥¿æ±‰æ¨¡å¼</h3>
<pre><code>/**
 * é¥¿æ±‰å¼å•ä¾‹
 * çº¿ç¨‹å®‰å…¨ï¼Œä½†æ²¡æœ‰è¾¾åˆ°æ‡’åŠ è½½ç›®çš„
 */
public class Singeleton{
    private static final Singeleton instance = new Singeleton();
    // ç§æœ‰åŒ–æ„é€ å‡½æ•°
    private Singeleton(){
        // To Do
    }
    public static Singeleton getInstance(){
        return instance;
    }
}
</code></pre>
<p><strong>instanceä»€ä¹ˆæ—¶å€™è¢«åˆå§‹åŒ–ï¼Ÿ</strong></p>
<p>Singletonç±»è¢«åŠ è½½çš„æ—¶å€™å°±ä¼šè¢«åˆå§‹åŒ–ï¼Œjavaè™šæ‹Ÿæœºè§„èŒƒè™½ç„¶æ²¡æœ‰å¼ºåˆ¶æ€§çº¦æŸåœ¨ä»€ä¹ˆæ—¶å€™å¼€å§‹ç±»åŠ è½½è¿‡ç¨‹ï¼Œä½†æ˜¯å¯¹äºç±»çš„åˆå§‹åŒ–ï¼Œè™šæ‹Ÿæœºè§„èŒƒåˆ™ä¸¥æ ¼è§„å®šäº†æœ‰ä¸”åªæœ‰å››ç§æƒ…å†µå¿…é¡»ç«‹å³å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œé‡åˆ°newã€getStaticã€putStaticæˆ–invokeStaticè¿™4æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚<br>
ç”Ÿæˆè¿™4æ¡æŒ‡ä»¤æœ€å¸¸è§çš„javaä»£ç åœºæ™¯æ˜¯ï¼š</p>
<ul>
<li>ä½¿ç”¨newå…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡-</li>
<li>è¯»å–ä¸€ä¸ªç±»çš„é™æ€å­—æ®µï¼ˆè¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾åœ¨å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–ï¼‰</li>
<li>è®¾ç½®ä¸€ä¸ªç±»çš„é™æ€å­—æ®µï¼ˆè¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾åœ¨å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–ï¼‰</li>
<li>è°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•</li>
</ul>
<p><strong>classçš„ç”Ÿå‘½å‘¨æœŸ?</strong><br>
classçš„ç”Ÿå‘½å‘¨æœŸä¸€èˆ¬æ¥è¯´ä¼šç»å†åŠ è½½ã€è¿æ¥ã€åˆå§‹åŒ–ã€ä½¿ç”¨ã€å’Œå¸è½½äº”ä¸ªé˜¶æ®µ<br>
<strong>classçš„åŠ è½½æœºåˆ¶</strong><br>
è¿™é‡Œå¯ä»¥èŠä¸‹classloaderçš„åŒäº²å§”æ´¾æ¨¡å‹ã€‚</p>
<h3 id="æ‡’æ±‰æ¨¡å¼">æ‡’æ±‰æ¨¡å¼</h3>
<h4 id="æ‡’æ±‰æ¨¡å¼ä¸åŠ é”">æ‡’æ±‰æ¨¡å¼(ä¸åŠ é”)</h4>
<pre><code>/**
 * æ‡’æ±‰å¼å•ä¾‹
 * é€‚ç”¨äºå•çº¿ç¨‹ç¯å¢ƒï¼ˆä¸æ¨èï¼‰
 * 
 * å¤šçº¿ç¨‹ä¸å®‰å…¨
 * 
 * æ­¤æ–¹å¼åœ¨å•çº¿ç¨‹çš„æ—¶å€™å·¥ä½œæ­£å¸¸ï¼Œä½†åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹å°±æœ‰é—®é¢˜äº†ã€‚
 * å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œåˆ°åˆ¤æ–­instanceæ˜¯å¦ä¸ºnullçš„ifè¯­å¥ï¼Œå¹¶ä¸”instanceçš„ç¡®æ²¡æœ‰è¢«åˆ›å»ºæ—¶ï¼Œ
 * é‚£ä¹ˆä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œæ­¤æ—¶ç±»å‹Singletonå°±ä¸å†æ»¡è¶³å•ä¾‹æ¨¡å¼çš„è¦æ±‚äº†ã€‚
 */
public class Singeleton{
    private static Singeleton instance = null;
    private Singeleton(){}
    public Singeleton getInstance(){
        if(instance==null){
            instance = new Singeleton();
        }
        return instance;
    }
}
</code></pre>
<h4 id="æ‡’æ±‰æ¨¡å¼åŠ é”">æ‡’æ±‰æ¨¡å¼(åŠ é”)</h4>
<pre><code>/**
 * æ‡’æ±‰å¼å•ä¾‹
 * é€‚ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒï¼Œä½†æ•ˆç‡ä¸é«˜ï¼ˆä¸æ¨èï¼‰
 * 
 * ä¸ºäº†ä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æˆ‘ä»¬è¿˜æ˜¯åªèƒ½å¾—åˆ°è¯¥ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œ
 * åªéœ€è¦åœ¨getInstanceB()æ–¹æ³•åŠ ä¸ŠåŒæ­¥å…³é”®å­—sychronizedï¼Œå°±å¯ä»¥äº†ã€‚
 * ä½†æ¯æ¬¡è°ƒç”¨getInstanceB()æ–¹æ³•æ—¶éƒ½è¢«synchronizedå…³é”®å­—é”ä½äº†ï¼Œä¼šå¼•èµ·çº¿ç¨‹é˜»å¡ï¼Œå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚
 */
public class Singeleton {
    private static Singeleton instance = null;
    private Singeleton(){}
    public static synchronized Singeleton getInstance(){
        if(instance==null){
            instance = new Singeleton();
        }
        return instance;
    }
    public static void main(String[] args) {
        Singeleton singeleton = Singeleton.getInstance();
        System.out.println(singeleton);
    }
}
</code></pre>
<h3 id="åŒé‡æ£€æŸ¥dcl">åŒé‡æ£€æŸ¥DCL</h3>
<pre><code>/**
 * 
 * åŒé‡æ£€æŸ¥åŠ é”ï¼ˆæ¨èï¼‰
 * çº¿ç¨‹å®‰å…¨
 * 
 */
/*
public class Singeleton{
    private static Singeleton instance;
    private Singeleton(){}
    public static Singeleton getInstance(){
        // å…ˆåˆ¤æ–­å®ä¾‹æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å†å¯¹ç±»å¯¹è±¡è¿›è¡ŒåŠ é”å¤„ç†
        if(instance==null){
            synchronized(Singeleton.class){
                if(instance==null){
                    instance = new Singeleton();
                }
            }
        }
        return instance;
    }
    public static void main(String[] args) {
        Singeleton singeleton = Singeleton.getInstance();
        System.out.println(singeleton);
    }
}
</code></pre>
<p>æ¨èç†ç”±ï¼š</p>
<ul>
<li>å»¶è¿Ÿåˆå§‹åŒ–ã€‚å’Œæ‡’æ±‰æ¨¡å¼ä¸€è‡´ï¼Œåªæœ‰åœ¨åˆæ¬¡è°ƒç”¨é™æ€æ–¹æ³•getSingletonï¼Œæ‰ä¼šåˆå§‹åŒ–signletonå®ä¾‹ã€‚</li>
<li>æ€§èƒ½ä¼˜åŒ–ã€‚åŒæ­¥ä¼šé€ æˆæ€§èƒ½ä¸‹é™ï¼Œåœ¨åŒæ­¥å‰é€šè¿‡åˆ¤è¯»singletonæ˜¯å¦åˆå§‹åŒ–ï¼Œå‡å°‘ä¸å¿…è¦çš„åŒæ­¥å¼€é”€ã€‚</li>
<li>çº¿ç¨‹å®‰å…¨ã€‚åŒæ­¥åˆ›å»ºSingletonå¯¹è±¡ï¼ŒåŒæ—¶æ³¨æ„åˆ°é™æ€å˜é‡singletonä½¿ç”¨volatileä¿®é¥°ã€‚</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨volatileä¿®é¥°ï¼Ÿ</strong><br>
è™½ç„¶å·²ç»ä½¿ç”¨synchronizedè¿›è¡ŒåŒæ­¥ï¼Œä½†åœ¨ç¬¬4æ­¥åˆ›å»ºå¯¹è±¡æ—¶ï¼Œä¼šæœ‰ä¸‹é¢çš„ä¼ªä»£ç ï¼š</p>
<pre><code>memory=allocate(); //1ï¼šåˆ†é…å†…å­˜ç©ºé—´
ctorInstance();   //2:åˆå§‹åŒ–å¯¹è±¡
singleton=memory; //3:è®¾ç½®singletonæŒ‡å‘åˆšæ’åºçš„å†…å­˜ç©ºé—´
</code></pre>
<p>å¤åˆ¶ä»£ç å½“çº¿ç¨‹Aåœ¨æ‰§è¡Œä¸Šé¢ä¼ªä»£ç æ—¶ï¼Œ2å’Œ3å¯èƒ½ä¼šå‘ç”Ÿé‡æ’åºï¼Œå› ä¸ºé‡æ’åºå¹¶ä¸å½±å“è¿è¡Œç»“æœï¼Œè¿˜å¯ä»¥æå‡æ€§èƒ½ï¼Œæ‰€ä»¥JVMæ˜¯å…è®¸çš„ã€‚å¦‚æœæ­¤æ—¶ä¼ªä»£ç å‘ç”Ÿé‡æ’åºï¼Œæ­¥éª¤å˜ä¸º1-&gt;3-&gt;2,çº¿ç¨‹Aæ‰§è¡Œåˆ°ç¬¬3æ­¥æ—¶ï¼Œçº¿ç¨‹Bè°ƒç”¨getsingletonæ–¹æ³•ï¼Œåœ¨åˆ¤æ–­singleton==nullæ—¶ä¸ä¸ºnullï¼Œåˆ™è¿”å›singletonã€‚ä½†æ­¤æ—¶singletonå¹¶è¿˜æ²¡åˆå§‹åŒ–å®Œæ¯•ï¼Œçº¿ç¨‹Bè®¿é—®çš„å°†æ˜¯ä¸ªè¿˜æ²¡åˆå§‹åŒ–å®Œæ¯•çš„å¯¹è±¡ã€‚å½“å£°æ˜å¯¹è±¡çš„å¼•ç”¨ä¸ºvolatileåï¼Œä¼ªä»£ç çš„2ã€3çš„é‡æ’åºåœ¨å¤šçº¿ç¨‹ä¸­å°†è¢«ç¦æ­¢ã€‚<br>
synchronizedåŒæ­¥å—é‡Œé¢èƒ½å¤Ÿä¿è¯åªåˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚ä½†æ˜¯é€šè¿‡åœ¨synchronizedçš„å¤–é¢å¢åŠ ä¸€å±‚åˆ¤æ–­ï¼Œå°±å¯ä»¥åœ¨å¯¹è±¡ä¸€ç»åˆ›å»ºä»¥åï¼Œä¸å†è¿›å…¥synchronizedåŒæ­¥å—ã€‚è¿™ç§æ–¹æ¡ˆä¸ä»…å‡å°äº†é”çš„ç²’åº¦ï¼Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œæ€§èƒ½æ–¹é¢ä¹Ÿå¾—åˆ°äº†å¤§å¹…æå‡ã€‚<br>
åŒæ—¶è¿™é‡Œè¦æ³¨æ„ä¸€å®šè¦è¯´volatileï¼Œè¿™ä¸ªå¾ˆå…³é”®ï¼Œvolatileä¸€èˆ¬ç”¨äºå¤šçº¿ç¨‹çš„å¯è§æ€§ï¼Œä½†æ˜¯è¿™é‡Œæ˜¯ç”¨æ¥é˜²æ­¢æŒ‡ä»¤é‡æ’åºçš„ã€‚<br>
<strong>æ‰©å±•:</strong><br>
<strong>ä¸ºä»€ä¹ˆéœ€è¦volatileï¼Ÿvolatileæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</strong></p>
<ol>
<li>é¦–å…ˆè¦å›ç­”å¯è§æ€§ï¼Œè¿™ä¸ªæ˜¯æ¯‹åº¸è´¨ç–‘çš„ï¼Œç„¶åå¯èƒ½åˆä¼šè€ƒåˆ°javaå†…å­˜æ¨¡å‹ã€‚</li>
<li>é˜²æ­¢æŒ‡ä»¤é‡æ’åº: é˜²æ­¢new Singletonæ—¶æŒ‡ä»¤é‡æ’åºå¯¼è‡´å…¶ä»–çº¿ç¨‹è·å–åˆ°æœªåˆå§‹åŒ–å®Œçš„å¯¹è±¡ã€‚instance = new Singleton()è¿™å¥ï¼Œè¿™å¹¶éæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œäº‹å®ä¸Šåœ¨ JVM ä¸­è¿™å¥è¯å¤§æ¦‚åšäº†ä¸‹é¢ 3 ä»¶äº‹æƒ…ã€‚1.ç»™ instance åˆ†é…å†…å­˜2.è°ƒç”¨ Singleton çš„æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–æˆå‘˜å˜é‡3.å°†instanceå¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜ç©ºé—´ï¼ˆæ‰§è¡Œå®Œè¿™æ­¥ instance å°±ä¸ºé null äº†ï¼‰<br>
ä½†æ˜¯åœ¨ JVM çš„å³æ—¶ç¼–è¯‘å™¨ä¸­å­˜åœ¨æŒ‡ä»¤é‡æ’åºçš„ä¼˜åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥çš„é¡ºåºæ˜¯ä¸èƒ½ä¿è¯çš„ï¼Œæœ€ç»ˆçš„æ‰§è¡Œé¡ºåºå¯èƒ½æ˜¯ 1-2-3 ä¹Ÿå¯èƒ½æ˜¯ 1-3-2ã€‚å¦‚æœæ˜¯åè€…ï¼Œåˆ™åœ¨ 3 æ‰§è¡Œå®Œæ¯•ã€2 æœªæ‰§è¡Œä¹‹å‰ï¼Œè¢«çº¿ç¨‹äºŒæŠ¢å äº†ï¼Œè¿™æ—¶ instance å·²ç»æ˜¯é null äº†ï¼ˆä½†å´æ²¡æœ‰åˆå§‹åŒ–ï¼‰ï¼Œæ‰€ä»¥çº¿ç¨‹äºŒä¼šç›´æ¥è¿”å› instanceï¼Œç„¶åä½¿ç”¨ï¼Œç„¶åæŠ¥é”™ã€‚</li>
<li>é¡ºä¾¿ä¹Ÿå¯ä»¥è¯´ä¸‹volatieåŸç†ç”¨å†…å­˜å±éšœ</li>
</ol>
<p><strong>è®²è®²synchronizedå’Œvolatileçš„åŒºåˆ«</strong><br>
è¿™é‡Œå¯ä»¥ä»synchroizedèƒ½ä¿è¯åŸå­æ€§ï¼Œvolatileä¸èƒ½ä¿è¯è¯´èµ·ï¼Œä»¥åŠè®²ä¸‹synchroizedæ˜¯é‡é‡çº§é”ï¼Œç”šè‡³å¯ä»¥æ‰€ä»¥ä¸‹ä»–å’ŒLockçš„åŒºåˆ«ç­‰ç­‰ã€‚<br>
<strong>çº¿ç¨‹å®‰å…¨ä¸€èˆ¬æ€ä¹ˆå®ç°çš„?</strong></p>
<p>äº’æ–¥åŒæ­¥ã€‚å¦‚lock,synchroized<br>
éé˜»å¡åŒæ­¥ã€‚å¦‚casã€‚<br>
ä¸åŒæ­¥ã€‚å¦‚threadLocal,å±€éƒ¨å˜é‡ã€‚</p>
<h3 id="é™æ€å†…éƒ¨ç±»">é™æ€å†…éƒ¨ç±»</h3>
<pre><code>/**
 * 
 * é™æ€å†…éƒ¨ç±»æ–¹å¼ï¼ˆæ¨èï¼‰
 * åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œå…¶å†…éƒ¨ç±»ä¸ä¼šåŒæ—¶è¢«åŠ è½½ã€‚ä¸€ä¸ªç±»è¢«åŠ è½½ï¼Œå½“ä¸”ä»…å½“å…¶æŸä¸ªé™æ€æˆå‘˜ï¼ˆé™æ€åŸŸã€æ„é€ å™¨ã€é™æ€æ–¹æ³•ç­‰ï¼‰è¢«è°ƒç”¨æ—¶å‘ç”Ÿã€‚ ç”±äºåœ¨è°ƒç”¨ StaticSingleton.getInstance() çš„æ—¶å€™ï¼Œæ‰ä¼šå¯¹å•ä¾‹è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œä¸”é€šè¿‡åå°„
 * æ˜¯ä¸èƒ½ä»å¤–éƒ¨ç±»è·å–å†…éƒ¨ç±»çš„å±æ€§çš„ï¼›ç”±äºé™æ€å†…éƒ¨ç±»çš„ç‰¹æ€§ï¼Œåªæœ‰åœ¨å…¶è¢«ç¬¬ä¸€æ¬¡å¼•ç”¨çš„æ—¶å€™æ‰ä¼šè¢«åŠ è½½ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨æ€§ã€‚
 * æ€»ç»“ï¼š
 * ä¼˜åŠ¿ï¼šå…¼é¡¾äº†æ‡’æ±‰æ¨¡å¼çš„å†…å­˜ä¼˜åŒ–ï¼ˆä½¿ç”¨æ—¶æ‰åˆå§‹åŒ–ï¼‰ä»¥åŠé¥¿æ±‰æ¨¡å¼çš„å®‰å…¨æ€§ï¼ˆä¸ä¼šè¢«åå°„å…¥ä¾µï¼‰ã€‚
 * åŠ£åŠ¿ï¼šéœ€è¦ä¸¤ä¸ªç±»å»åšåˆ°è¿™ä¸€ç‚¹ï¼Œè™½ç„¶ä¸ä¼šåˆ›å»ºé™æ€å†…éƒ¨ç±»çš„å¯¹è±¡ï¼Œä½†æ˜¯å…¶ Class å¯¹è±¡è¿˜æ˜¯ä¼šè¢«åˆ›å»ºï¼Œè€Œä¸”æ˜¯å±äºæ°¸ä¹…å¸¦çš„å¯¹è±¡ã€‚
 * 
 */
/*
public class Singeleton{
    private static Singeleton instance = null;
    private Singeleton(){}
    public static Singeleton getInstance(){
        if(instance==null){
            instance = inner.singeleton;
        }
        return instance;
    }

    public void methodA() {
        System.out.println(&quot;It's methodA&quot;);
    }

    public void methodB() {
        System.out.println(&quot;It's methodB&quot;);
    }
    private static class inner{
        private static final Singeleton singeleton = new Singeleton();
    }
    public static void main(String[] args) {
        Singeleton singeleton = Singeleton.getInstance();
        singeleton.methodA();
        singeleton.methodB();
    }
}
</code></pre>
<p><strong>æ¨èç†ç”±ï¼š</strong></p>
<ul>
<li>å®ç°ä»£ç ç®€æ´ã€‚å’ŒåŒé‡æ£€æŸ¥å•ä¾‹å¯¹æ¯”ï¼Œé™æ€å†…éƒ¨ç±»å•ä¾‹å®ç°ä»£ç çœŸçš„æ˜¯å¤ªç®€æ´ï¼Œåˆæ¸…æ™°æ˜äº†ã€‚</li>
<li>å»¶è¿Ÿåˆå§‹åŒ–ã€‚è°ƒç”¨getSingletonæ‰åˆå§‹åŒ–Singletonå¯¹è±¡ã€‚</li>
<li>çº¿ç¨‹å®‰å…¨ã€‚JVMåœ¨æ‰§è¡Œç±»çš„åˆå§‹åŒ–é˜¶æ®µï¼Œä¼šè·å¾—ä¸€ä¸ªå¯ä»¥åŒæ­¥å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªç±»çš„åˆå§‹åŒ–çš„é”ã€‚</li>
</ul>
<p><strong>å¦‚ä½•å®ç°çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong><br>
çº¿ç¨‹Aå’Œçº¿ç¨‹BåŒæ—¶è¯•å›¾è·å¾—Singletonå¯¹è±¡çš„åˆå§‹åŒ–é”ï¼Œå‡è®¾çº¿ç¨‹Aè·å–åˆ°äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸€ç›´ç­‰å¾…åˆå§‹åŒ–é”ã€‚çº¿ç¨‹Aæ‰§è¡Œç±»åˆå§‹åŒ–ï¼Œå°±ç®—åŒé‡æ£€æŸ¥æ¨¡å¼ä¸­ä¼ªä»£ç å‘ç”Ÿäº†é‡æ’åºï¼Œä¹Ÿä¸ä¼šå½±å“çº¿ç¨‹Açš„åˆå§‹åŒ–ç»“æœã€‚åˆå§‹åŒ–å®Œåï¼Œé‡Šæ”¾é”ã€‚çº¿ç¨‹Bè·å¾—åˆå§‹åŒ–é”ï¼Œå‘ç°Singletonå¯¹è±¡å·²ç»åˆå§‹åŒ–å®Œæ¯•ï¼Œé‡Šæ”¾é”ï¼Œä¸è¿›è¡Œåˆå§‹åŒ–ï¼Œè·å¾—Singletonå¯¹è±¡ã€‚<br>
åœ¨æ¶‰åŠåˆ°åå°„å’Œåºåˆ—åŒ–çš„å•ä¾‹ä¸­ï¼Œå»ºè®®ä½¿ç”¨ä¸‹æ–‡çš„æšä¸¾ç±»å‹æ¨¡å¼ã€‚</p>
<h3 id="æšä¸¾ç±»">æšä¸¾ç±»</h3>
<pre><code>/**
 * 
 * æšä¸¾
 * å¤šçº¿ç¨‹å®‰å…¨
 * èƒ½è‡ªåŠ¨é¿å…åºåˆ—åŒ–/ååºåˆ—åŒ–æ”»å‡»ï¼Œä»¥åŠåå°„æ”»å‡»(æšä¸¾ç±»ä¸èƒ½é€šè¿‡åå°„ç”Ÿæˆ)
 */
public class Singeleton{
    private Singeleton(){}
    /**
     * æšä¸¾ç±»å‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”åªä¼šè£…è½½ä¸€æ¬¡
     */
    private enum Single{
        INSTANCE;
        private final Singeleton instance;
        Single(){
            instance = new Singeleton();
        }
        private Singeleton getInstance(){
            return instance;
        }
    }
    public static Singeleton getInstance(){
        return Single.INSTANCE.getInstance();
    }
}
</code></pre>
<p>é€šè¿‡æšä¸¾ç±»ï¼Œä»–èƒ½è‡ªåŠ¨é¿å…åºåˆ—åŒ–/ååºåˆ—åŒ–æ”»å‡»ï¼Œä»¥åŠåå°„æ”»å‡»(æšä¸¾ç±»ä¸èƒ½é€šè¿‡åå°„ç”Ÿæˆ)ã€‚<br>
å‚è€ƒæ–‡ç« ï¼š<br>
<a href="https://juejin.im/post/5cf09270f265da1bd260d239">https://juejin.im/post/5cf09270f265da1bd260d239</a><br>
<a href="https://juejin.im/post/5b50b0dd6fb9a04f932ff53f">https://juejin.im/post/5b50b0dd6fb9a04f932ff53f</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Javaä¸­çš„å †(heap)å’Œæ ˆ(stack)]]></title>
        <id>https://hefeijoe.github.io/post/stackandheap/</id>
        <link href="https://hefeijoe.github.io/post/stackandheap/">
        </link>
        <updated>2020-05-28T01:48:09.000Z</updated>
        <content type="html"><![CDATA[<h1 id="æ ˆstack">æ ˆ(stack)ğŸ¤ </h1>
<p>Javaé‡Œé¢Stackæœ‰ä¸¤ç§å«ä¹‰ï¼š</p>
<h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</h2>
<p>Stack,å³java.util.Stackï¼Œæ˜¯Vectorçš„ä¸€ä¸ªå­ç±»ï¼Œå®ƒå®ç°äº†ä¸€ä¸ªæ ‡å‡†çš„åè¿›å…ˆå‡ºçš„æ ˆã€‚<br>
Stackçš„ç‰¹ç‚¹ä¸ºLIFOï¼Œå³åè¿›å…ˆå‡ºï¼ˆLast in, first outï¼‰ã€‚</p>
<pre><code>public class Stack01 {
    public static void main(String[] args) {
        Stack&lt;Integer&gt; stack = new Stack&lt;&gt;();
        stack.push(1);//æŠŠå…ƒç´ å‹æ ˆ
        stack.empty();//åˆ¤æ–­stackæ˜¯å¦ä¸ºç©º
        stack.peek();//å–æ ˆé¡¶å…ƒç´ ä½†ä¸å¼¹å‡º
        stack.search(1);//è¿”å›å¯¹è±¡åœ¨å †æ ˆä¸­çš„ä½ç½®ï¼Œä»¥ 1 ä¸ºåŸºæ•°ã€‚æ²’æœ‰æŸ¥åˆ°åˆ™è¿”å›-1ã€‚
        stack.pop();//æŠŠæ ˆé¡¶çš„å…ƒç´ â€œå¼¹å‡ºâ€
    }
}
</code></pre>
<p>ä¸€èˆ¬ä¸ä¹‹æ¯”è¾ƒçš„æ˜¯é˜Ÿåˆ—Queueï¼Œé˜Ÿåˆ—æ˜¯ä¸¤ä¸ªå£ï¼Œå…ˆè¿›å…ˆå‡ºã€‚</p>
<h2 id="å†…å­˜åŒºåŸŸ">å†…å­˜åŒºåŸŸğŸ˜š</h2>
<p>ç³»ç»Ÿä¸€èˆ¬åœ¨å†…å­˜ä¸­åˆ’åˆ†å‡ºä¸¤ç§ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä¸€ç§æ˜¯Stack(æ ˆ),ä¸€ç§æ˜¯heap(å †)ã€‚<br>
<img src="https://pic1.zhimg.com/80/v2-e83cdfa865e6fb71caf65d7803c081bc_720w.jpg" alt="stack" loading="lazy"></p>
<h3 id="æ ˆçš„ç»„æˆ">æ ˆçš„ç»„æˆ</h3>
<p>æ ˆå¸§ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š<strong>å±€éƒ¨å˜é‡åŒº</strong>ã€<strong>æ“ä½œæ•°æ ˆ</strong>ã€<strong>å¸§æ•°æ®åŒº</strong>ã€‚å±€éƒ¨å˜é‡åŒºå’Œæ“ä½œæ•°æ ˆçš„å¤§å°è¦è§†å¯¹åº”çš„æ–¹æ³•è€Œå®šï¼Œä»–ä»¬æ˜¯æŒ‰å­—é•¿è®¡ç®—çš„ã€‚ä½†è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå®ƒä»ç±»å‹ä¿¡æ¯ä¸­å¾—åˆ°æ­¤æ–¹æ³•å±€éƒ¨å˜é‡åŒºå’Œæ“ä½œæ•°æ ˆå¤§å°ï¼Œå¹¶æ®æ­¤åˆ†é…æ ˆå†…å­˜ï¼Œç„¶åå‹å…¥Javaæ ˆã€‚</p>
<h4 id="å±€éƒ¨å˜é‡åŒº">å±€éƒ¨å˜é‡åŒº</h4>
<p><strong>å±€éƒ¨å˜é‡åŒº</strong>è¢«ç»„ç»‡ä¸ºä»¥ä¸€ä¸ªå­—é•¿ä¸ºå•ä½ã€ä»0å¼€å§‹è®¡æ•°çš„æ•°ç»„ï¼Œç±»å‹ä¸ºshortã€byteå’Œcharçš„å€¼åœ¨å­˜å…¥æ•°ç»„å‰è¦è¢«è½¬æ¢æˆintå€¼ï¼Œè€Œlongå’Œdoubleåœ¨æ•°ç»„ä¸­å æ®è¿ç»­çš„ä¸¤é¡¹ï¼Œåœ¨è®¿é—®å±€éƒ¨å˜é‡ä¸­çš„longæˆ–doubleæ—¶ï¼Œåªéœ€å–å‡ºè¿ç»­ä¸¤é¡¹çš„ç¬¬ä¸€é¡¹çš„ç´¢å¼•å€¼å³å¯,å¦‚æŸä¸ªlongå€¼åœ¨å±€éƒ¨å˜é‡åŒºä¸­å æ®çš„ç´¢å¼•æ—¶3ã€4é¡¹ï¼Œå–å€¼æ—¶ï¼ŒæŒ‡ä»¤åªéœ€å–ç´¢å¼•ä¸º3çš„longå€¼å³å¯ã€‚</p>
<pre><code>public static int runClassMethod(int i,long l,float f,double d,Object o,byte b) { 
    return 0;   
}
public int runInstanceMethod(char c,double d,short s,boolean b) { 
    return 0;   
}
</code></pre>
<h4 id="æ“ä½œæ•°æ ˆ">æ“ä½œæ•°æ ˆ</h4>
<p>å’Œå±€éƒ¨å˜é‡åŒºä¸€æ ·ï¼Œæ“ä½œæ•°æ ˆä¹Ÿè¢«ç»„ç»‡æˆä¸€ä¸ªä»¥å­—é•¿ä¸ºå•ä½çš„æ•°ç»„ã€‚ä½†å’Œå‰è€…ä¸åŒçš„æ˜¯ï¼Œå®ƒä¸æ˜¯é€šè¿‡ç´¢å¼•æ¥è®¿é—®çš„ï¼Œè€Œæ˜¯é€šè¿‡å…¥æ ˆå’Œå‡ºæ ˆæ¥è®¿é—®çš„ã€‚å¯æŠŠæ“ä½œæ•°æ ˆç†è§£ä¸ºå­˜å‚¨è®¡ç®—æ—¶ï¼Œä¸´æ—¶æ•°æ®çš„å­˜å‚¨åŒºåŸŸã€‚<br>
æ“ä½œæ•°æ ˆå…¶å®å°±æ˜¯ä¸ªä¸´æ—¶æ•°æ®å­˜å‚¨åŒºåŸŸï¼Œå®ƒæ˜¯é€šè¿‡å…¥æ ˆå’Œå‡ºæ ˆæ¥è¿›è¡Œæ“ä½œçš„ã€‚</p>
<h4 id="å¸§æ•°æ®åŒº">å¸§æ•°æ®åŒº</h4>
<p>åœ¨å‰é¢å°±æè¿°è¿‡ï¼šæ ˆæ˜¯ç”±æ ˆå¸§ç»„æˆï¼Œæ¯å½“çº¿ç¨‹è°ƒç”¨ä¸€ä¸ªjavaæ–¹æ³•æ—¶ï¼ŒJVMå°±ä¼šåœ¨è¯¥çº¿ç¨‹å¯¹åº”çš„æ ˆä¸­å‹å…¥ä¸€ä¸ªå¸§ï¼Œè€Œå¸§æ˜¯ç”±å±€éƒ¨å˜é‡åŒºã€æ“ä½œæ•°æ ˆå’Œå¸§æ•°æ®åŒºç»„æˆã€‚</p>
<ol>
<li>åªæœ‰åœ¨è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œæ‰ä¸ºå½“å‰æ ˆåˆ†é…ä¸€ä¸ªå¸§ï¼Œç„¶åå°†è¯¥å¸§å‹å…¥æ ˆ;</li>
<li>å¸§ä¸­å­˜å‚¨äº†å¯¹åº”æ–¹æ³•çš„å±€éƒ¨æ•°æ®ï¼Œæ–¹æ³•æ‰§è¡Œå®Œï¼Œå¯¹åº”çš„å¸§åˆ™ä»æ ˆä¸­å¼¹å‡ºï¼Œå¹¶æŠŠè¿”å›ç»“æœå­˜å‚¨åœ¨è°ƒç”¨æ–¹æ³•çš„å¸§çš„æ“ä½œæ•°æ ˆä¸­ã€‚</li>
</ol>
<h1 id="å †">å †ğŸ˜µ</h1>
<p>å †ä¸­åˆ†é…çš„æ˜¯å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯newå‡ºæ¥çš„ä¸œè¥¿ã€‚<br>
<img src="https://pic1.zhimg.com/80/v2-00dc88198eef4f42a3dd1e34ee5cd5f7_720w.jpg" alt="heap" loading="lazy"></p>
<h1 id="å†…å­˜åˆ†é…ä¸¾ä¸ªæ —å­">å†…å­˜åˆ†é…ï¼ˆä¸¾ä¸ªæ —å­ï¼‰</h1>
<pre><code>public void Method1()
{
    int i = 4;
    int y = 2;
    class1 cls1 = new class1();
}
</code></pre>
<p>å†…å­˜åˆ†é…æ˜¯è¿™æ ·çš„ï¼š<br>
<img src="https://pic1.zhimg.com/80/1519fb641bdb1ee150fcfb621b0afdd8_720w.jpg" alt="img" loading="lazy"></p>
<h1 id="å †å’Œæ ˆçš„åŒºåˆ«">å †å’Œæ ˆçš„åŒºåˆ«ğŸ¤—</h1>
<ul>
<li>åŠŸèƒ½ä¸åŒ<br>
æ ˆå†…å­˜ç”¨æ¥å­˜å‚¨å±€éƒ¨å˜é‡å’Œæ–¹æ³•è°ƒç”¨ã€‚<br>
è€Œå †å†…å­˜ç”¨æ¥å­˜å‚¨Javaä¸­çš„å¯¹è±¡ã€‚æ— è®ºæ˜¯æˆå‘˜å˜é‡ï¼Œå±€éƒ¨å˜é‡ï¼Œè¿˜æ˜¯ç±»å˜é‡ï¼Œå®ƒä»¬æŒ‡å‘çš„å¯¹è±¡éƒ½å­˜å‚¨åœ¨å †å†…å­˜ä¸­ã€‚</li>
<li>å…±äº«æ€§ä¸åŒ<br>
Â Â æ ˆå†…å­˜æ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚<br>
Â Â å †å†…å­˜æ˜¯æ‰€æœ‰çº¿ç¨‹å…±æœ‰çš„ã€‚</li>
<li>å¼‚å¸¸é”™è¯¯ä¸åŒ<br>
Â Â å¦‚æœæ ˆå†…å­˜æˆ–è€…å †å†…å­˜ä¸è¶³éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚<br>
Â Â æ ˆç©ºé—´ä¸è¶³ï¼šjava.lang.StackOverFlowErrorã€‚<br>
Â Â å †ç©ºé—´ä¸è¶³ï¼šjava.lang.OutOfMemoryErrorã€‚</li>
<li>ç©ºé—´å¤§å°<br>
Â Â æ ˆçš„ç©ºé—´å¤§å°è¿œè¿œå°äºå †çš„ã€‚</li>
<li>ç»“æ„<br>
Â Â stackæ˜¯æœ‰ç»“æ„çš„ï¼Œæ¯ä¸ªåŒºå—æŒ‰ç…§ä¸€å®šæ¬¡åºå­˜æ”¾ï¼Œå¯ä»¥æ˜ç¡®çŸ¥é“æ¯ä¸ªåŒºå—çš„å¤§å°ï¼›heapæ˜¯æ²¡æœ‰ç»“æ„çš„ï¼Œæ•°æ®å¯ä»¥ä»»æ„å­˜æ”¾ã€‚å› æ­¤ï¼Œstackçš„å¯»å€é€Ÿåº¦è¦å¿«äºheapã€‚</li>
<li>å­˜æ”¾è§„åˆ™<br>
Â Â æ•°æ®å­˜æ”¾çš„è§„åˆ™æ˜¯ï¼šåªè¦æ˜¯å±€éƒ¨çš„ã€å ç”¨ç©ºé—´ç¡®å®šçš„æ•°æ®ï¼Œä¸€èˆ¬éƒ½å­˜æ”¾åœ¨stacké‡Œé¢ï¼Œå¦åˆ™å°±æ”¾åœ¨heapé‡Œé¢ã€‚</li>
</ul>
<h3 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h3>
<p><a href="https://www.zhihu.com/question/29833675/">https://www.zhihu.com/question/29833675</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Traefik V2åŸºäºKubernetesçš„å®‰è£…ä¸ä½¿ç”¨]]></title>
        <id>https://hefeijoe.github.io/post/traefik-k8s-use/</id>
        <link href="https://hefeijoe.github.io/post/traefik-k8s-use/">
        </link>
        <updated>2020-05-20T07:05:06.000Z</updated>
        <content type="html"><![CDATA[<h1 id="æ ¸å¿ƒæ¦‚å¿µ">æ ¸å¿ƒæ¦‚å¿µğŸ˜€</h1>
<p>Traefik æ˜¯ä¸€ä¸ªè¾¹ç¼˜è·¯ç”±å™¨ï¼Œæ˜¯ä½ æ•´ä¸ªå¹³å°çš„å¤§é—¨ï¼Œæ‹¦æˆªå¹¶è·¯ç”±æ¯ä¸ªä¼ å…¥çš„è¯·æ±‚ï¼šå®ƒçŸ¥é“æ‰€æœ‰çš„é€»è¾‘å’Œè§„åˆ™ï¼Œè¿™äº›è§„åˆ™ç¡®å®šå“ªäº›æœåŠ¡å¤„ç†å“ªäº›è¯·æ±‚ï¼›ä¼ ç»Ÿçš„åå‘ä»£ç†éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«è·¯ç”±åˆ°ä½ æœåŠ¡çš„æ‰€æœ‰å¯èƒ½è·¯ç”±ï¼Œè€Œ Traefik ä¼šå®æ—¶æ£€æµ‹æœåŠ¡å¹¶è‡ªåŠ¨æ›´æ–°è·¯ç”±è§„åˆ™ï¼Œå¯ä»¥è‡ªåŠ¨æœåŠ¡å‘ç°ã€‚<br>
<img src="https://docs.traefik.io/assets/img/traefik-architecture.png" alt="img" loading="lazy"><br>
é¦–å…ˆï¼Œå½“å¯åŠ¨ Traefik æ—¶ï¼Œéœ€è¦å®šä¹‰ entrypointsï¼ˆå…¥å£ç‚¹ï¼‰ï¼Œç„¶åï¼Œæ ¹æ®è¿æ¥åˆ°è¿™äº› entrypoints çš„è·¯ç”±æ¥åˆ†æä¼ å…¥çš„è¯·æ±‚ï¼Œæ¥æŸ¥çœ‹ä»–ä»¬æ˜¯å¦ä¸ä¸€ç»„è§„åˆ™ç›¸åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™è·¯ç”±å¯èƒ½ä¼šå°†è¯·æ±‚é€šè¿‡ä¸€ç³»åˆ—ä¸­é—´ä»¶è½¬æ¢è¿‡åå†è½¬å‘åˆ°ä½ çš„æœåŠ¡ä¸Šå»ã€‚åœ¨äº†è§£ Traefik ä¹‹å‰æœ‰å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µæˆ‘ä»¬å¿…é¡»è¦äº†è§£ï¼š</p>
<ul>
<li><strong>Providers</strong> ç”¨æ¥è‡ªåŠ¨å‘ç°å¹³å°ä¸Šçš„æœåŠ¡ï¼Œå¯ä»¥æ˜¯ç¼–æ’å·¥å…·ã€å®¹å™¨å¼•æ“æˆ–è€… key-value å­˜å‚¨ç­‰ï¼Œæ¯”å¦‚ Dockerã€Kubernetesã€Fileã€‚</li>
<li><strong>Entrypoints</strong> ç›‘å¬ä¼ å…¥çš„æµé‡ï¼ˆç«¯å£ç­‰â€¦ï¼‰ï¼Œæ˜¯ç½‘ç»œå…¥å£ç‚¹ï¼Œå®ƒä»¬å®šä¹‰äº†æ¥æ”¶è¯·æ±‚çš„ç«¯å£ï¼ˆHTTP æˆ–è€… TCPï¼‰ã€‚</li>
<li><strong>Routers</strong> åˆ†æè¯·æ±‚ï¼ˆhost, path, headers, SSL, â€¦ï¼‰ï¼Œè´Ÿè´£å°†ä¼ å…¥è¯·æ±‚è¿æ¥åˆ°å¯ä»¥å¤„ç†è¿™äº›è¯·æ±‚çš„æœåŠ¡ä¸Šå»ã€‚</li>
<li><strong>Services</strong> å°†è¯·æ±‚è½¬å‘ç»™ä½ çš„åº”ç”¨ï¼ˆload balancing, â€¦ï¼‰ï¼Œè´Ÿè´£é…ç½®å¦‚ä½•è·å–æœ€ç»ˆå°†å¤„ç†ä¼ å…¥è¯·æ±‚çš„å®é™…æœåŠ¡ã€‚</li>
<li><strong>Middlewares</strong> ä¸­é—´ä»¶ï¼Œç”¨æ¥ä¿®æ”¹è¯·æ±‚æˆ–è€…æ ¹æ®è¯·æ±‚æ¥åšå‡ºä¸€äº›åˆ¤æ–­ï¼ˆauthentication, rate limiting, headers, â€¦ï¼‰ï¼Œä¸­é—´ä»¶è¢«é™„ä»¶åˆ°è·¯ç”±ä¸Šï¼Œæ˜¯ä¸€ç§åœ¨è¯·æ±‚å‘é€åˆ°ä½ çš„æœåŠ¡ä¹‹å‰ï¼ˆæˆ–è€…åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼‰è°ƒæ•´è¯·æ±‚çš„ä¸€ç§æ–¹æ³•ã€‚</li>
</ul>
<h1 id="éƒ¨ç½²">éƒ¨ç½²ğŸ˜„</h1>
<h2 id="kubernetes">Kubernetes</h2>
<p>ç”±äº Traefik 2.X ç‰ˆæœ¬å’Œä¹‹å‰çš„ 1.X ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰æ‹©åŠŸèƒ½æ›´åŠ å¼ºå¤§çš„ 2.X ç‰ˆæœ¬è¿›è¡Œéƒ¨ç½²ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„é•œåƒæ˜¯ traefik:2.0.2ã€‚<br>
åœ¨ Traefik ä¸­çš„é…ç½®å¯ä»¥ä½¿ç”¨ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼š</p>
<ul>
<li><strong>åŠ¨æ€é…ç½®</strong>ï¼šå®Œå…¨åŠ¨æ€çš„è·¯ç”±é…ç½®</li>
<li><strong>é™æ€é…ç½®</strong>ï¼šå¯åŠ¨é…ç½®<br>
é™æ€é…ç½®ä¸­çš„å…ƒç´ ï¼ˆè¿™äº›å…ƒç´ ä¸ä¼šç»å¸¸æ›´æ”¹ï¼‰è¿æ¥åˆ° providers å¹¶å®šä¹‰ Treafik å°†è¦ç›‘å¬çš„ entrypointsã€‚<br>
åœ¨ Traefik ä¸­æœ‰ä¸‰ç§æ–¹å¼å®šä¹‰é™æ€é…ç½®ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ã€åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­ã€é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’<br>
åŠ¨æ€é…ç½®åŒ…å«å®šä¹‰ç³»ç»Ÿå¦‚ä½•å¤„ç†è¯·æ±‚çš„æ‰€æœ‰é…ç½®å†…å®¹ï¼Œè¿™äº›é…ç½®æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œè€Œä¸”æ˜¯æ— ç¼çƒ­æ›´æ–°çš„ï¼Œæ²¡æœ‰ä»»ä½•è¯·æ±‚ä¸­æ–­æˆ–è¿æ¥æŸè€—ã€‚<br>
åœ¨Kubernetesé›†ç¾¤ä¸‹ï¼Œé‡‡ç”¨Deploymentçš„æ–¹å¼éƒ¨ç½²traefikï¼Œå¹¶ä¸”æ‰“å¼€kubernetes ingressï¼Œä»¥åŠprometheus metricsã€‚<br>
<em>æ³¨ï¼šé»˜è®¤å®‰è£…åœ¨<strong>default</strong>ä¸‹</em></li>
</ul>
<h3 id="crdä¸rbac">CRDä¸RBAC</h3>
<p>é¦–å…ˆï¼Œå®šä¹‰CRDåŒ…æ‹¬IngressRouteå’ŒMiddlewareã€‚å¹¶ä¸”é€šè¿‡RBACæˆæƒèµ„æºã€‚<br>
å‚è§ï¼šhttps://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-crd.yaml<br>
<em>æ³¨ï¼šé»˜è®¤å®‰è£…åœ¨<strong>default</strong>ä¸‹</em></p>
<pre><code>kubectl apply -f https://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-crd.yaml
</code></pre>
<h3 id="service">Service</h3>
<p>å‚è§ï¼šhttps://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-service.yaml</p>
<pre><code>kubectl apply -f https://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-crd.yaml
</code></pre>
<p>éƒ¨ç½²å®Œæˆtraefikçš„EXTERNAL-IPä¸º<a href="http://172.21.92.148:8080/dashboard/#/">172.21.92.146</a></p>
<h3 id="deployments">Deployments</h3>
<p>å‚è§ï¼šhttps://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-deployment.yaml</p>
<pre><code>kubectl apply -f https://github.com/HefeiJoe/traefik-k8s/blob/master/traefik-deployment.yaml
</code></pre>
<pre><code>apiVersion: v1
kind: ServiceAccount
metadata:
 name: traefik-ingress-controller
---
kind: Deployment
apiVersion: apps/v1
metadata:
 name: traefik
 labels:
  app: traefik
spec:
 replicas: 1
 selector:
  matchLabels:
   app: traefik
 template:
  metadata:
   labels:
â€‹    app: traefik
  spec:
   serviceAccountName: traefik-ingress-controller
   containers:
â€‹    - name: traefik
â€‹     image: traefik:v2.0.2
â€‹     args:
â€‹      - --api.insecure
â€‹      - --accesslog
â€‹      - --entrypoints.web.Address=:8000
â€‹      - --entrypoints.websecure.Address=:4443
â€‹      - --providers.kubernetescrd
â€‹      - --certificatesresolvers.default.acme.tlschallenge
â€‹      - --certificatesresolvers.default.acme.email=foo@you.com
â€‹      - --certificatesresolvers.default.acme.storage=acme.json
â€‹      - --providers.kubernetesingress=true
â€‹      - --providers.kubernetesingress.ingressclass=traefik
â€‹      - --metrics.prometheus=true
â€‹      - --entryPoints.metrics.address=:8082
â€‹      - --metrics.prometheus.entryPoint=metrics
â€‹      - --certificatesresolvers.default.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
â€‹     ports:
â€‹      - name: web
â€‹       containerPort: 8000
â€‹      - name: websecure
â€‹       containerPort: 4443
â€‹      - name: admin
â€‹       containerPort: 8080
â€‹      - name: prometheus
â€‹       containerPort: 8082
</code></pre>
<h3 id="è®¿é—®dashboard">è®¿é—®DashBoard</h3>
<p>è®¿é—®8080ç«¯å£ï¼Œ<a href="http://172.21.92.148:8080/dashboard/#/">http://172.21.92.146:8080/dashboard/#/</a><br>
å¯ä»¥æŸ¥çœ‹å¼€å¯çš„ç«¯å£ã€æ·»åŠ çš„HTTPæœåŠ¡ã€æ·»åŠ çš„TCPæœåŠ¡ã€å¯ç”¨çš„Middlewareã€å¯ç”¨çš„Featuresã€å·²ç»æˆä¿¡çš„åŠŸèƒ½ã€‚<br>
<img src="https://uploader.shimo.im/f/9KL50flf9hg1UaL8.png!thumbnail" alt="img" loading="lazy"></p>
<h2 id="helm-chart">Helm Chart</h2>
<p>Helm Chartåœ°å€ï¼šhttps://github.com/containous/traefik-helm-chart<br>
helm install --namespace=default  ./traefik-helm-chart<br>
#ä½¿ç”¨</p>
<h3 id="éƒ¨ç½²whoamiæœåŠ¡">éƒ¨ç½²whoamiæœåŠ¡</h3>
<p>éƒ¨ç½²æµ‹è¯•æœåŠ¡whoami<br>
å‚è§ï¼šhttps://github.com/HefeiJoe/traefik-k8s/blob/master/whoami.yaml</p>
<h2 id="ingress">Ingress</h2>
<p>åœ¨traefikçš„Deploymentä¸­çš„argä¸‹æ·»åŠ CLI<br>
<em>- --providers.kubernetesingress=true</em><br>
<em>- --providers.kubernetesingress.ingressclass=traefik</em><br>
1ã€åˆ›å»ºIngress</p>
<pre><code>kind: Ingress
apiVersion: extensions/v1beta1
metadata:
  namespace: default
 name: traefik-ingress
 annotations:
  *# use the shared ingress-nginx*
  kubernetes.io/ingress.class: traefik
</code></pre>
<p>2ã€éªŒè¯<br>
è®¿é—®æœåŠ¡curl -i 172.21.92.146:8000  -H &quot;Host:whoami.kong.test&quot;ï¼Œæ¥å£å“åº”200<br>
<img src="https://uploader.shimo.im/f/ffocrRF3UjkXYBEb.png!thumbnail" alt="img" loading="lazy"></p>
<h2 id="ingressroute">IngressRoute</h2>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: simpleingressroute
  namespace: default
spec:
  entryPoints:
â€‹    - web
  routes:
  - match: Host(`172.21.92.148`) &amp;&amp; PathPrefix(`/whoami`)
â€‹    kind: Rule
â€‹    services:
â€‹    - name: whoami
â€‹      port: 80
</code></pre>
<p>é€šè¿‡http://172.21.92.148:8000/whoamiè®¿é—®</p>
<h2 id="middlewaresä¸­é—´ä»¶">Middlewaresï¼ˆä¸­é—´ä»¶ï¼‰</h2>
<h3 id="overviewæ¦‚è¿°">Overviewï¼ˆæ¦‚è¿°ï¼‰</h3>
<h3 id=""><img src="https://uploader.shimo.im/f/S1b2FXezLpQkSqx3.png!thumbnail" alt="img" loading="lazy"></h3>
<p>å°†ä¸­é—´ä»¶æ·»åŠ åˆ°Routeï¼Œåœ¨è¯·æ±‚å‘é€åˆ°æœåŠ¡ä¹‹å‰(æˆ–åœ¨æœåŠ¡çš„å“åº”å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰)è°ƒæ•´è¯·æ±‚ã€‚<br>
Traefikä¸­æœ‰è®¸å¤šä¸åŒçš„ä¸­é—´ä»¶ï¼Œæœ‰äº›å¯ä»¥ä¿®æ”¹è¯·æ±‚ã€å¤´æ–‡ä»¶ï¼Œæœ‰äº›è´Ÿè´£é‡å®šå‘ï¼Œæœ‰äº›æ·»åŠ èº«ä»½éªŒè¯ï¼Œç­‰ç­‰ã€‚<br>
<strong>ç»™Routeç»‘å®šMiddleware</strong><br>
åœ¨ingressRouteä¸­æ·»åŠ middlewares<br>
<em># As a Kubernetes Traefik IngressRoute</em></p>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: stripprefix
spec:
  stripPrefix:
â€‹    prefixes:
â€‹      - /stripit
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: simpleingressroute
  namespace: default
spec:
  entryPoints:
â€‹    - web
  routes:
  - match: Host(`172.21.92.148`) &amp;&amp; PathPrefix(`/whoami`)
â€‹    kind: Rule
â€‹    services:
â€‹    - name: whoami
â€‹      port: 80
â€‹    middlewares:
- name: stripprefix
</code></pre>
<p>Available Middlewares<a href="https://docs.traefik.io/middlewares/overview/#available-middlewares">Â¶</a></p>
<table>
<thead>
<tr>
<th>Middleware</th>
<th>Purpose</th>
<th>Area</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.traefik.io/middlewares/addprefix/">AddPrefix</a></td>
<td>Add a Path Prefix</td>
<td>Path Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/basicauth/">BasicAuth</a></td>
<td>Basic auth mechanism</td>
<td>Security, Authentication</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/buffering/">Buffering</a></td>
<td>Buffers the request/response</td>
<td>Request Lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/chain/">Chain</a></td>
<td>Combine multiple pieces of middleware</td>
<td>Middleware tool</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/circuitbreaker/">CircuitBreaker</a></td>
<td>Stop calling unhealthy services</td>
<td>Request Lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/compress/">Compress</a></td>
<td>Compress the response</td>
<td>Content Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/digestauth/">DigestAuth</a></td>
<td>Adds Digest Authentication</td>
<td>Security, Authentication</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/errorpages/">Errors</a></td>
<td>Define custom error pages</td>
<td>Request Lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/forwardauth/">ForwardAuth</a></td>
<td>Authentication delegation</td>
<td>Security, Authentication</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/headers/">Headers</a></td>
<td>Add / Update headers</td>
<td>Security</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/ipwhitelist/">IPWhiteList</a></td>
<td>Limit the allowed client IPs</td>
<td>Security, Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/inflightreq/">InFlightReq</a></td>
<td>Limit the number of simultaneous connections</td>
<td>Security, Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/passtlsclientcert/">PassTLSClientCert</a></td>
<td>Adding Client Certificates in a Header</td>
<td>Security</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/ratelimit/">RateLimit</a></td>
<td>Limit the call frequency</td>
<td>Security, Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/redirectscheme/">RedirectScheme</a></td>
<td>Redirect easily the client elsewhere</td>
<td>Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/redirectregex/">RedirectRegex</a></td>
<td>Redirect the client elsewhere</td>
<td>Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/replacepath/">ReplacePath</a></td>
<td>Change the path of the request</td>
<td>Path Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/replacepathregex/">ReplacePathRegex</a></td>
<td>Change the path of the request</td>
<td>Path Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/retry/">Retry</a></td>
<td>Automatically retry the request in case of errors</td>
<td>Request lifecycle</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/stripprefix/">StripPrefix</a></td>
<td>Change the path of the request</td>
<td>Path Modifier</td>
</tr>
<tr>
<td><a href="https://docs.traefik.io/middlewares/stripprefixregex/">StripPrefixRegex</a></td>
<td>Change the path of the request</td>
<td>Path Modifier</td>
</tr>
</tbody>
</table>
<h3 id="addprefixæ·»åŠ å‰ç¼€">AddPrefixï¼ˆæ·»åŠ å‰ç¼€ï¼‰</h3>
<p><img src="https://uploader.shimo.im/f/1hy4I9o9piED68sO.png!thumbnail" alt="img" loading="lazy"><br>
<em># Prefixing with /foo</em></p>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: add-foo
spec:
  addPrefix:
â€‹    prefix: /foo
</code></pre>
<table>
<thead>
<tr>
<th>é…ç½®é€‰é¡¹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>prefix</td>
<td>prefixæ˜¯æ·»åŠ åœ¨è¯·æ±‚çš„URLè·¯å¾„ä¹‹å‰çš„å­—ç¬¦ä¸²ã€‚å®ƒåº”è¯¥åŒ…æ‹¬å‰å¯¼æ–œæ (/)ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/addprefix/#prefix">Â¶</a></td>
</tr>
</tbody>
</table>
<h3 id="basicauthåŸºæœ¬è®¤è¯">BasicAuthï¼ˆåŸºæœ¬è®¤è¯ï¼‰</h3>
<p><img src="https://uploader.shimo.im/f/IRa08Sg9kIIT5DuU.png!thumbnail" alt="img" loading="lazy"><br>
<em># Declaring the user list</em></p>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: test-auth
spec:
  basicAuth:
â€‹    secret: secretName
</code></pre>
<table>
<thead>
<tr>
<th>é…ç½®é€‰é¡¹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>secret</td>
<td>ç»‘å®šåˆ›å»ºçš„secretã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#configuration-examples">Â¶</a></td>
</tr>
<tr>
<td>users</td>
<td>è¯¥usersé€‰é¡¹æ˜¯ä¸€ç»„æˆæƒç”¨æˆ·ã€‚æ¯ä¸ªç”¨æˆ·éƒ½å°†ä½¿ç”¨ä»¥ä¸‹name:encoded-passwordæ ¼å¼å£°æ˜ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#usersfile">Â¶</a></td>
</tr>
<tr>
<td>usersFile</td>
<td>è¯¥usersFileé€‰é¡¹æ˜¯åŒ…å«ä¸­é—´ä»¶æˆæƒç”¨æˆ·çš„å¤–éƒ¨æ–‡ä»¶çš„è·¯å¾„ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#realm">Â¶</a></td>
</tr>
<tr>
<td>realm</td>
<td>æ‚¨å¯ä»¥ä½¿ç”¨realmé€‰é¡¹æ¥è‡ªå®šä¹‰èº«ä»½éªŒè¯é¢†åŸŸã€‚é»˜è®¤å€¼ä¸ºtraefikã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#realm">Â¶</a></td>
</tr>
<tr>
<td>headerField</td>
<td>æ‚¨å¯ä»¥ä½¿ç”¨è¯¥headerFieldé€‰é¡¹å®šä¹‰æ ‡é¢˜å­—æ®µä»¥å­˜å‚¨ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#headerfield">Â¶</a></td>
</tr>
<tr>
<td>removeHeader</td>
<td>è®¾ç½®removeHeaderé€‰é¡¹ä»¥trueåœ¨å°†è¯·æ±‚è½¬å‘åˆ°æœåŠ¡ä¹‹å‰åˆ é™¤æˆæƒæ ‡å¤´ã€‚ï¼ˆé»˜è®¤å€¼ä¸ºfalseã€‚ï¼‰å‚è€ƒ<a href="https://docs.traefik.io/middlewares/basicauth/#removeheader">Â¶</a></td>
</tr>
</tbody>
</table>
<h3 id="circuitbreakeræ–­è·¯å™¨">CircuitBreakerï¼ˆæ–­è·¯å™¨ï¼‰</h3>
<p><img src="https://uploader.shimo.im/f/Jf3qvl3fwsgp5pDV.png!thumbnail" alt="img" loading="lazy"><br>
æ–­è·¯å™¨å¯ä¿æŠ¤æ‚¨çš„ç³»ç»Ÿå…äºå°†è¯·æ±‚å †å åˆ°ä¸æ­£å¸¸çš„æœåŠ¡ï¼ˆå¯¼è‡´çº§è”æ•…éšœï¼‰çš„éº»çƒ¦ã€‚<br>
ç³»ç»Ÿè¿è¡ŒçŠ¶å†µè‰¯å¥½æ—¶ï¼Œç”µè·¯å¤„äºé—­åˆçŠ¶æ€ï¼ˆæ­£å¸¸è¿è¡Œï¼‰ã€‚å½“ç³»ç»Ÿè¿è¡Œä¸æ­£å¸¸æ—¶ï¼Œç”µè·¯å°†æ–­å¼€ï¼Œå¹¶ä¸”ä¸å†è½¬å‘è¯·æ±‚ï¼ˆè€Œæ˜¯ç”±åå¤‡æœºåˆ¶å¤„ç†ï¼‰ã€‚<br>
ä¸ºäº†è¯„ä¼°æ‚¨çš„ç³»ç»Ÿæ˜¯å¦å¥åº·ï¼Œæ–­è·¯å™¨ä¸æ–­ç›‘è§†æœåŠ¡ã€‚<br>
<em># Latency Check</em></p>
<pre><code>apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: latency-check
spec:
  circuitBreaker:
â€‹    expression: LatencyAtQuantileMS(50.0) &gt; 100
</code></pre>
<table>
<thead>
<tr>
<th>é…ç½®é€‰é¡¹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>NetworkErrorRatio</td>
<td>å¦‚æœæ‚¨å¸Œæœ›æ–­è·¯å™¨ä»¥30ï¼…çš„ç½‘ç»œé”™è¯¯ç‡è§¦å‘ï¼Œåˆ™è¡¨è¾¾å¼ä¸º NetworkErrorRatio() &gt; 0.30ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/addprefix/#prefix">Â¶</a></td>
</tr>
<tr>
<td>ResponseCodeRatio</td>
<td>æ‚¨å¯ä»¥æ ¹æ®ç»™å®šèŒƒå›´çš„çŠ¶æ€ç çš„æ¯”ç‡æ¥è§¦å‘æ–­è·¯å™¨ã€‚åœ¨ResponseCodeRatioæ¥å—å››ä¸ªå‚æ•°ï¼Œfromï¼Œtoï¼ŒdividedByFromï¼ŒdividedByToã€‚ä¾‹å¦‚ï¼ŒResponseCodeRatio(500, 600, 0, 600) &gt; 0.25å¦‚æœ25ï¼…çš„è¯·æ±‚è¿”å›5XXçŠ¶æ€ï¼ˆåœ¨è¿”å›çŠ¶æ€ä»£ç ä»0åˆ°5XXçš„è¯·æ±‚ä¸­ï¼‰ï¼Œåˆ™è¡¨è¾¾å¼å°†è§¦å‘æ–­è·¯å™¨ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/circuitbreaker/#responsecoderatio">Â¶</a></td>
</tr>
<tr>
<td>LatencyAtQuantileMS</td>
<td>å½“ç»™å®šæ¯”ä¾‹çš„è¯·æ±‚å˜å¾—å¤ªæ…¢æ—¶ï¼Œæ‚¨å¯ä»¥è§¦å‘æ–­è·¯å™¨ã€‚ä¾‹å¦‚ï¼Œå½“ä¸­LatencyAtQuantileMS(50.0) &gt; 100å€¼ç­‰å¾…æ—¶é—´ï¼ˆåˆ†ä½æ•°50ï¼‰è¾¾åˆ°100MSæ—¶ï¼Œè¯¥è¡¨è¾¾å¼å°†è§¦å‘æ–­è·¯å™¨ã€‚å‚è€ƒ<a href="https://docs.traefik.io/middlewares/circuitbreaker/#latencyatquantilems">Â¶</a>æ‚¨å¿…é¡»æä¾›åˆ†ä½æ•°çš„æµ®ç‚¹æ•°ï¼ˆåè·Ÿ.0ï¼‰</td>
</tr>
</tbody>
</table>
<h2 id="metrics">Metrics</h2>
<h3 id="prometheus">Prometheus</h3>
<p>åœ¨traefikçš„Deploymentä¸­çš„argä¸‹æ·»åŠ CLIï¼ˆå¦‚æœé‡‡ç”¨HelmChartéƒ¨ç½²ï¼Œåœ¨values.yamlçš„additionalArgumentsä¸‹æ·»åŠ ä»¥ä¸‹CLIï¼‰ï¼Œå¹¶ä¸”ä¿®æ”¹Serviceæš´éœ²ç«¯å£8082<br>
<em>- --metrics.prometheus=true</em><br>
<em>- --entryPoints.metrics.address=:8082</em><br>
<em>- --metrics.prometheus.entryPoint=metrics</em><br>
é€šè¿‡8082ç«¯å£å¯ä»¥æŸ¥çœ‹prometheusçš„metricsï¼Œ<a href="http://172.21.92.148:8082/metrics">http://172.21.92.146:8082/metrics</a></p>
<h2 id="tracing">Tracing</h2>
<h3 id="zipkin">Zipkin</h3>
<p>1ã€éƒ¨ç½²Zipkin<br>
ç•¥<br>
2ã€åœ¨traefikçš„Deploymentä¸­çš„argä¸‹æ·»åŠ CLIï¼ˆå¦‚æœé‡‡ç”¨HelmChartéƒ¨ç½²ï¼Œåœ¨values.yamlçš„additionalArgumentsä¸‹æ·»åŠ ä»¥ä¸‹CLIï¼‰<br>
<em>- --tracing.zipkin=true</em><br>
<em>- --tracing.zipkin.httpEndpoint=http://localhost:9411/api/v2/spans</em><br>
<em>- --tracing.zipkin.sampleRate=1.0</em><br>
è®¿é—®zipkinçš„åœ°å€ï¼Œhttp://localhost:9411/</p>
]]></content>
    </entry>
</feed>